<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fahrzeit-Alarm</title>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c5282">
    <!-- Apple iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Fahrzeit-Alarm">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <style>
        *{box-sizing:border-box;margin:0;padding:0}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;line-height:1.6;color:#333;background:linear-gradient(135deg,#1a3a5f 0%,#2c5282 100%);padding:20px;min-height:100vh}.container{max-width:800px;margin:0 auto;background:white;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.3);overflow:hidden}header{background:linear-gradient(120deg,#0c243c 0%,#1a3a5f 100%);color:white;padding:25px 30px;text-align:center}h1{font-size:2.2rem;margin-bottom:10px;text-shadow:0 2px 4px rgba(0,0,0,.3)}.subtitle{font-size:1.1rem;opacity:.9;margin-top:5px}.content{padding:30px}.setup-container{background:#f8f9fa;border-radius:12px;padding:25px;margin-bottom:25px;box-shadow:0 4px 12px rgba(0,0,0,.08)}.form-group{margin-bottom:20px}label{display:block;margin-bottom:8px;font-weight:600;font-size:1.1rem;color:#1a3a5f}input[type=number]{width:100%;padding:14px;border:2px solid #4a6fa5;border-radius:8px;font-size:1.3rem;transition:border-color .3s}input[type=number]:focus{outline:none;border-color:#1a3a5f;box-shadow:0 0 0 3px rgba(26,58,95,.2)}.btn{background:linear-gradient(120deg,#1a3a5f 0%,#2c5282 100%);color:white;border:none;padding:14px 28px;font-size:1.2rem;font-weight:600;border-radius:8px;cursor:pointer;transition:all .3s;box-shadow:0 4px 10px rgba(26,58,95,.4);width:100%;margin-top:10px}.btn:hover{background:linear-gradient(120deg,#152e4c 0%,#254772 100%);transform:translateY(-2px);box-shadow:0 6px 15px rgba(26,58,95,.5)}.btn:active{transform:translateY(0)}.btn-start{background:linear-gradient(120deg,#28a745 0%,#20c997 100%)}.btn-start:hover{background:linear-gradient(120deg,#218838 0%,#1ba87e 100%)}.btn-pause{background:linear-gradient(120deg,#ffc107 0%,#ff9800 100%)}.btn-pause:hover{background:linear-gradient(120deg,#e0a800 0%,#f57c00 100%)}.btn-stop{background:linear-gradient(120deg,#dc3545 0%,#e83e8c 100%)}.btn-stop:hover{background:linear-gradient(120deg,#c82333 0%,#e41e78 100%)}.timer-display{text-align:center;margin:30px 0;display:none}.timer-display.show{display:block;animation:fadeIn .5s ease-out}.timer-value{font-size:4.5rem;font-weight:700;color:#1a3a5f;font-family:'Courier New',monospace;margin:20px 0;text-shadow:0 2px 4px rgba(0,0,0,.1)}.timer-label{font-size:1.4rem;color:#5a6b82;margin-bottom:15px}.status-indicator{display:inline-block;width:20px;height:20px;border-radius:50%;margin-right:10px;vertical-align:middle}.status-driving{background:#28a745;box-shadow:0 0 10px #28a745}.status-break{background:#ffc107;box-shadow:0 0 10px #ffc107}.status-idle{background:#6c757d}.status-text{font-size:1.3rem;font-weight:600;display:inline-block;vertical-align:middle}.alarm-container{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);display:none;justify-content:center;align-items:center;z-index:1000;flex-direction:column}.alarm-container.show{display:flex;animation:pulse 1s infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.8}}.alarm-box{background:white;border-radius:20px;padding:40px;text-align:center;max-width:90%;box-shadow:0 20px 60px rgba(0,0,0,.5)}.alarm-title{font-size:2.8rem;color:#dc3545;margin-bottom:20px;font-weight:700}.alarm-message{font-size:2rem;color:#333;margin-bottom:30px;line-height:1.5}.alarm-buttons{display:flex;gap:20px;justify-content:center;flex-wrap:wrap}.alarm-btn{padding:15px 40px;font-size:1.3rem;font-weight:600;border-radius:10px;cursor:pointer;transition:all .3s;min-width:180px;border:none}.alarm-btn-confirm{background:#28a745;color:white}.alarm-btn-confirm:hover{background:#218838;transform:scale(1.05)}.alarm-btn-later{background:#ffc107;color:#333}.alarm-btn-later:hover{background:#e0a800;transform:scale(1.05)}.law-highlight{background:#eef4ff;border-left:5px solid #4a6fa5;padding:20px;margin:20px 0;border-radius:0 10px 10px 0;font-weight:500;line-height:1.6;font-size:1.2rem;position:relative}.law-highlight::before{content:"¬ß";position:absolute;left:-20px;top:-10px;font-size:4rem;color:rgba(74,111,165,.2);font-weight:bold}.break-history{margin-top:30px;background:#f8f9fa;border-radius:10px;padding:20px}.break-history h3{color:#1a3a5f;margin-bottom:15px;font-size:1.5rem}.break-list{list-style:none}.break-item{padding:12px;border-bottom:1px solid #dee2e6;display:flex;justify-content:space-between}.break-item:last-child{border-bottom:none}.break-time{font-weight:600;color:#1a3a5f}.break-duration{background:#28a745;color:white;padding:3px 10px;border-radius:15px;font-size:.9rem}.progress-container{margin:25px 0}.progress-label{display:flex;justify-content:space-between;margin-bottom:8px;font-weight:600;color:#1a3a5f}.progress-bar{height:25px;background:#e9ecef;border-radius:12px;overflow:hidden;box-shadow:inset 0 1px 3px rgba(0,0,0,.2)}.progress-fill{height:100%;background:linear-gradient(90deg,#28a745 0%,#20c997 100%);transition:width .5s ease;border-radius:12px}.progress-text{text-align:center;color:white;font-weight:600;line-height:25px;text-shadow:0 1px 2px rgba(0,0,0,.3)}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}@media (max-width:600px){.content{padding:20px}h1{font-size:1.8rem}.timer-value{font-size:3.5rem}.alarm-title{font-size:2.2rem}.alarm-message{font-size:1.6rem}.alarm-btn{padding:12px 30px;font-size:1.1rem;min-width:150px}}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöó Fahrzeit-Alarm</h1>
            <div class="subtitle">Pausenbenachrichtigung nach deutschem Fahrrecht</div>
        </header>
        
        <div class="content">
            <div class="setup-container" id="setupContainer">
                <div class="form-group">
                    <label for="totalHours">Geplante Fahrzeit in Stunden:</label>
                    <input type="number" id="totalHours" name="totalHours" step="0.5" min="0.5" value="10" required placeholder="z.B. 10">
                </div>
                <button class="btn btn-start" id="startBtn">‚ñ∂Ô∏è Fahrt beginnen</button>
            </div>
            
            <div class="law-highlight">
                ‚ö†Ô∏è Nach 4,5 Stunden ununterbrochener Lenkzeit muss eine Pause von mindestens 45 Minuten eingelegt werden
            </div>
            
            <div class="timer-display" id="timerDisplay">
                <div class="timer-label">
                    <span class="status-indicator status-idle" id="statusIndicator"></span>
                    <span class="status-text" id="statusText">Bereit</span>
                </div>
                <div class="timer-value" id="timerValue">00:00:00</div>
                
                <div class="progress-container">
                    <div class="progress-label">
                        <span>N√§chste Pause in</span>
                        <span id="progressText">4,5h</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill">
                            <div class="progress-text" id="progressFillText">0%</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-pause" id="pauseBtn">‚è∏Ô∏è Fahrt pausieren</button>
                <button class="btn btn-start" id="resumeBtn" style="display:none;">‚ñ∂Ô∏è Weiterfahren</button>
                <button class="btn btn-stop" id="stopBtn">‚èπÔ∏è Fahrt beenden</button>
            </div>
            
            <div class="break-history" id="breakHistory" style="display:none;">
                <h3>üìä Pausenverlauf</h3>
                <ul class="break-list" id="breakList"></ul>
            </div>
        </div>
    </div>
    
    <div class="alarm-container" id="alarmContainer">
        <div class="alarm-box">
            <div class="alarm-title">‚ö†Ô∏è PAUSE ERFORDERLICH!</div>
            <div class="alarm-message" id="alarmMessage">
                Sie haben 4,5 Stunden ununterbrochen gefahren.<br>
                Bitte machen Sie jetzt eine Pause von mindestens 45 Minuten.
            </div>
            <div class="alarm-buttons">
                <button class="alarm-btn alarm-btn-confirm" id="alarmConfirmBtn">‚úÖ Pause beginnen</button>
                <button class="alarm-btn alarm-btn-later" id="alarmLaterBtn">‚è∞ In 15 Min. erinnern</button>
            </div>
        </div>
    </div>

    <script>
        let audioContext, alarmSoundInterval, alarmSoundTimeout;
        let isRunning = false, isPaused = false, startTime, elapsedTime = 0, lastBreakTime = 0, breakCount = 0;
        let breakAlarmTimeout, nextBreakIn = 4.5 * 60 * 60 * 1000;
        
        const setupContainer = document.getElementById('setupContainer');
        const timerDisplay = document.getElementById('timerDisplay');
        const timerValue = document.getElementById('timerValue');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const progressFillText = document.getElementById('progressFillText');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resumeBtn = document.getElementById('resumeBtn');
        const stopBtn = document.getElementById('stopBtn');
        const totalHoursInput = document.getElementById('totalHours');
        const alarmContainer = document.getElementById('alarmContainer');
        const alarmConfirmBtn = document.getElementById('alarmConfirmBtn');
        const alarmLaterBtn = document.getElementById('alarmLaterBtn');
        const alarmMessage = document.getElementById('alarmMessage');
        const breakHistoryContainer = document.getElementById('breakHistory');
        const breakList = document.getElementById('breakList');
        
        function formatTime(ms) {
            const h = Math.floor(ms / 3600000);
            const m = Math.floor((ms % 3600000) / 60000);
            const s = Math.floor((ms % 60000) / 1000);
            return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }
        
        function createAlarmSound() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const o = audioContext.createOscillator();
                const g = audioContext.createGain();
                o.connect(g);
                g.connect(audioContext.destination);
                o.type = 'square';
                o.frequency.value = 880;
                g.gain.value = 0.3;
                o.start();
                alarmSoundInterval = setInterval(() => {
                    g.gain.value = g.gain.value === 0.3 ? 0 : 0.3;
                }, 500);
                alarmSoundTimeout = setTimeout(() => {
                    o.stop();
                    clearInterval(alarmSoundInterval);
                }, 30000);
            } catch (e) { console.log('Audio not supported'); }
        }
        
        function stopAlarmSound() {
            if (alarmSoundInterval) clearInterval(alarmSoundInterval);
            if (alarmSoundTimeout) clearTimeout(alarmSoundTimeout);
            if (audioContext) audioContext.close();
            audioContext = alarmSoundInterval = alarmSoundTimeout = null;
        }
        
        function showAlarm() {
            createAlarmSound();
            alarmContainer.classList.add('show');
            alarmMessage.innerHTML = breakCount === 0 ? 
                `‚è∞ <strong>ERSTE PAUSE ERFORDERLICH!</strong><br>Sie haben 4,5 Stunden ununterbrochen gefahren.<br>Bitte machen Sie jetzt eine Pause von mindestens 45 Minuten.` :
                `‚è∞ <strong>N√ÑCHSTE PAUSE ERFORDERLICH!</strong><br>Sie haben seit Ihrer letzten Pause 4,5 Stunden gefahren.<br>Bitte machen Sie jetzt eine Pause von mindestens 45 Minuten.`;
        }
        
        function hideAlarm() {
            stopAlarmSound();
            alarmContainer.classList.remove('show');
        }
        
        function scheduleNextBreak() {
            if (breakAlarmTimeout) clearTimeout(breakAlarmTimeout);
            breakAlarmTimeout = setTimeout(showAlarm, nextBreakIn);
        }
        
        function updateTimer() {
            if (!isRunning || isPaused) return;
            const now = Date.now();
            const timeSinceStart = now - startTime + elapsedTime;
            const timeSinceLastBreak = now - lastBreakTime;
            timerValue.textContent = formatTime(timeSinceStart);
            const progress = Math.min(100, (timeSinceLastBreak / nextBreakIn) * 100);
            const hoursLeft = 4.5 - (timeSinceLastBreak / 3600000);
            progressFill.style.width = `${progress}%`;
            progressFillText.textContent = `${Math.round(progress)}%`;
            progressText.textContent = `${Math.max(0, hoursLeft).toFixed(1)}h`;
            if (progress >= 90) progressFill.style.background = 'linear-gradient(90deg, #dc3545 0%, #e83e8c 100%)';
            else if (progress >= 70) progressFill.style.background = 'linear-gradient(90deg, #ffc107 0%, #ff9800 100%)';
            else progressFill.style.background = 'linear-gradient(90deg, #28a745 0%, #20c997 100%)';
        }
        
        function startJourney() {
            const h = parseFloat(totalHoursInput.value);
            if (isNaN(h) || h <= 0) return alert('Bitte g√ºltige Fahrzeit eingeben (min. 0,5h)');
            isRunning = true; isPaused = false; startTime = Date.now(); elapsedTime = 0; lastBreakTime = Date.now(); breakCount = 0; breakList.innerHTML = '';
            setupContainer.style.display = 'none'; timerDisplay.classList.add('show'); breakHistoryContainer.style.display = 'block';
            statusIndicator.className = 'status-indicator status-driving'; statusText.textContent = '‚ñ∂Ô∏è Fahrt l√§uft';
            pauseBtn.style.display = 'block'; resumeBtn.style.display = 'none';
            scheduleNextBreak(); setInterval(updateTimer, 1000);
        }
        
        function pauseJourney() {
            if (!isRunning || isPaused) return;
            isPaused = true; elapsedTime += Date.now() - startTime;
            statusIndicator.className = 'status-indicator status-break'; statusText.textContent = '‚è∏Ô∏è Pause';
            breakCount++;
            const li = document.createElement('li');
            li.className = 'break-item';
            li.innerHTML = `<span class="break-time">Pause ${breakCount} begonnen um ${new Date().toLocaleTimeString('de-DE')}</span><span class="break-duration">45 min</span>`;
            breakList.prepend(li);
            lastBreakTime = Date.now(); scheduleNextBreak();
            pauseBtn.style.display = 'none'; resumeBtn.style.display = 'block';
            alert('‚úÖ Pause gestartet!\n\nNach 45 Minuten k√∂nnen Sie mit "Weiterfahren" fortsetzen.');
        }
        
        function resumeJourney() {
            if (!isRunning || !isPaused) return;
            isPaused = false; startTime = Date.now();
            statusIndicator.className = 'status-indicator status-driving'; statusText.textContent = '‚ñ∂Ô∏è Fahrt l√§uft';
            pauseBtn.style.display = 'block'; resumeBtn.style.display = 'none';
        }
        
        function stopJourney() {
            isRunning = false; isPaused = false; clearTimeout(breakAlarmTimeout);
            const total = elapsedTime + (Date.now() - startTime);
            const h = Math.floor(total / 3600000);
            const m = Math.floor((total % 3600000) / 60000);
            alert(`Fahrt beendet!\n\nGesamtfahrzeit: ${h}h ${m}min\nPausen: ${breakCount}`);
            setupContainer.style.display = 'block'; timerDisplay.classList.remove('show'); breakHistoryContainer.style.display = 'none';
            pauseBtn.style.display = 'block'; resumeBtn.style.display = 'none';
        }
        
        startBtn.addEventListener('click', startJourney);
        pauseBtn.addEventListener('click', pauseJourney);
        resumeBtn.addEventListener('click', resumeJourney);
        stopBtn.addEventListener('click', stopJourney);
        alarmConfirmBtn.addEventListener('click', () => { hideAlarm(); pauseJourney(); });
        alarmLaterBtn.addEventListener('click', () => {
            hideAlarm();
            clearTimeout(breakAlarmTimeout);
            breakAlarmTimeout = setTimeout(showAlarm, 15 * 60 * 1000);
            alert('‚è∞ Erinnerung in 15 Minuten gesetzt.\n\nHinweis: Gesetzliche Pause sollte nicht weiter verschoben werden!');
        });
        
        // Service Worker registrieren
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(err => console.log('SW-Fehler:', err));
            });
        }
        
        statusIndicator.className = 'status-indicator status-idle';
        resumeBtn.style.display = 'none';
    </script>
</body>
</html>